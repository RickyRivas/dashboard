<script lang="ts">
	import { page } from '$app/state';
	import Logo from '$lib/Logo.svelte';
	import { findRouteInfo, type RouteInfo } from '$lib/navigation';
	import BuildTracker from '$lib/widgets/BuildTracker.svelte';
	import ThemeToggle from './ThemeToggle.svelte';

	interface navProps {
		navType: 'protected' | 'public';
		routes: RouteInfo[];
	}

	let isActive = $state(false);
	const toggleNav = () => (isActive = !isActive);
	const logout = async () => await page.data.supabase.auth.signOut();

	const session = $derived(page.data.session);
	let { navType, routes }: navProps = $props();

	let currentPagePath = $derived(page.url.pathname);
	// let protectedRoute = $derived(findRouteInfo(currentPagePath)?.group === 'protected');
</script>

<header id="main-nav">
	<div class="container">
		<div class="logo-flag">
			<a id="logo" href="/"> <Logo /> </a>
			<svg
				class="flag"
				aria-hidden="true"
				role="img"
				xmlns="http://www.w3.org/2000/svg"
				width="73"
				height="38"
				fill="none"
				viewBox="0 0 73 38"
			>
				<path fill="#B31942" d="M0 0h72.2v38H0" />
				<path
					fill="#fff"
					d="M72.2 32.154v2.923H0v-2.923h72.2Zm0-5.847v2.924H0v-2.924h72.2Zm0-5.846v2.923H0v-2.923h72.2Zm0-5.846v2.923H0v-2.923h72.2Zm0-5.846v2.923H0V8.77h72.2Zm0-5.846v2.923H0V2.923h72.2Z"
				/>
				<path fill="#0A3161" d="M0 0h28.88v20.462H0" />
				<path
					fill="#fff"
					d="M2.67 18.054h.849l-.687.5.262.807-.687-.499-.687.5.262-.809-.687-.499h.85l.262-.808.262.808Zm4.813 0h.85l-.688.5.263.807-.688-.499-.687.5.262-.809-.687-.499h.85l.262-.808.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.499-.687.5.263-.809-.687-.499h.85l.262-.808.262.808Zm4.813 0h.85l-.687.5.262.807-.687-.499-.687.5.262-.809-.687-.499h.85l.262-.808.262.808Zm4.814 0h.85l-.688.5.262.807-.687-.499-.687.5.262-.809-.687-.499h.85l.262-.808.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.499-.687.5.263-.809-.687-.499h.85l.262-.808.262.808Zm-21.66-2.046h.85l-.688.5.263.807-.687-.5-.688.5.263-.808-.687-.5h.85l.262-.807.262.808Zm4.813 0h.85l-.687.5.262.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.808Zm4.814 0h.85l-.688.5.262.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.807.262.808Zm4.813 0h.85l-.688.5.263.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.808ZM2.67 13.962h.85l-.687.5.262.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.808Zm4.814 0h.85l-.688.5.263.807-.688-.5-.687.5.262-.808-.687-.5h.85l.262-.807.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.807.262.808Zm4.813 0h.85l-.687.5.262.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.808Zm4.814 0h.85l-.688.5.262.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.807.262.808Zm-21.66-2.046h.85l-.688.499.263.808-.687-.5-.688.5.263-.808-.687-.5h.85l.262-.807.262.808Zm4.813 0h.85l-.687.499.262.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.808Zm4.814 0h.85l-.688.499.262.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.263.808Zm4.813 0h.85l-.688.499.263.808-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.807.262.808Zm4.813 0h.85l-.688.499.263.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.808ZM2.67 9.869h.85l-.687.5.262.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.807Zm4.814 0h.85l-.688.5.263.808-.688-.5-.687.5.262-.808-.687-.5h.85l.262-.807.263.807Zm4.813 0h.85l-.688.5.263.808-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.807.262.807Zm4.813 0h.85l-.687.5.262.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.807Zm4.814 0h.85l-.688.5.262.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.263.807Zm4.813 0h.85l-.688.5.263.808-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.807.262.807ZM5.076 7.823h.85l-.688.5.263.808-.687-.5-.688.5.263-.808-.687-.5h.85l.262-.808.262.808Zm4.813 0h.85l-.687.5.262.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.808.262.808Zm4.814 0h.85l-.688.5.262.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.808.263.808Zm4.813 0h.85l-.688.5.263.808-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.808.262.808Zm4.813 0h.85l-.688.5.263.808-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.808.262.808ZM2.67 5.777h.85l-.687.5.262.807-.687-.499-.687.5.262-.809-.687-.499h.85l.262-.808.262.808Zm4.814 0h.85l-.688.5.263.807-.688-.499-.687.5.262-.809-.687-.499h.85l.262-.808.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.499-.687.5.263-.809-.687-.499h.85l.262-.808.262.808Zm4.813 0h.85l-.687.5.262.807-.687-.499-.687.5.262-.809-.687-.499h.85l.262-.808.262.808Zm4.814 0h.85l-.688.5.262.807-.687-.499-.687.5.262-.809-.687-.499h.85l.262-.808.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.499-.687.5.263-.809-.687-.499h.85l.262-.808.262.808ZM5.076 3.731h.85l-.688.5.263.807-.687-.5-.688.5.263-.808-.687-.499h.85l.262-.808.262.808Zm4.813 0h.85l-.687.5.262.807-.687-.5-.687.5.262-.808-.687-.499h.85l.262-.808.262.808Zm4.814 0h.85l-.688.5.262.807-.687-.5-.687.5.262-.808-.687-.499h.85l.262-.808.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.5-.687.5.263-.808-.687-.499h.85l.262-.808.262.808Zm4.813 0h.85l-.688.5.263.807-.687-.5-.687.5.262-.808-.687-.499h.85l.262-.808.262.808ZM2.67 1.685h.85l-.687.5.262.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.808Zm4.814 0h.85l-.688.5.263.807-.688-.5-.687.5.262-.808-.687-.5h.85L7.22.878l.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.807.262.808Zm4.813 0h.85l-.687.5.262.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.262.808Zm4.814 0h.85l-.688.5.262.807-.687-.5-.687.5.262-.808-.687-.5h.85l.262-.807.263.808Zm4.813 0h.85l-.688.5.263.807-.688-.5-.687.5.263-.808-.687-.5h.85l.262-.807.262.808Z"
				/>
			</svg>
		</div>

		<div class="mod">
			<nav>
				<ul class:active={isActive}>
					{#if navType === 'protected'}
						<li>
							<BuildTracker />
						</li>
					{/if}
					{#each routes as route}
						<li class:active={currentPagePath.startsWith(route.path)}>
							<a id={route.name.toLowerCase()} href={route.path}>{route.name}</a>
						</li>
					{/each}
					{#if navType === 'protected'}
						<li>
							<button onclick={logout} class="btn">Logout</button>
						</li>
					{/if}

					{#if navType === 'public'}
						{#if session}
							<li>
								<a href="/app" class="btn">Dashboard</a>
							</li>
						{:else}
							<li>
								<a href="/login" class="btn">Log In</a>
							</li>
							<li>
								<a href="/register" class="btn">Register</a>
							</li>
						{/if}
					{/if}
				</ul>
			</nav>

			{#if navType === 'protected'}
				{#if page.data.profile}
					{#if page.data.profile.avatar_url}
						<div class="small-avatar">
							<img
								src={page.data.profile.avatar_url}
								alt={page.data.profile.full_name}
								width="40"
								height="40"
							/>
						</div>
					{/if}
				{/if}
			{/if}

			<ThemeToggle />

			<button
				id="nav-toggle"
				aria-label="Toggle"
				class:active={isActive}
				aria-expanded={isActive}
				onclick={toggleNav}
			>
				<span />
				<span />
				<span />
			</button>
		</div>
	</div>
</header>
